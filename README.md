# NestJS + GraphQL Schema First (Complete stack)

This repository includes a full cycle NestJS stack to develop with containers:

- NestJS + GraphQL Schema First (default application generated by `@nest/cli`);
- [Dockerfile](./Dockerfile) with multi-stage build and [`docker-compose`](./docker-compose.yml) to local development with live reload and debugger;
- [Redis](./k8s/redis/) (via Kubernetes with StatefulSet);
- [Dynatrace](./k8s/dynatrace/) (via Kubernetes) - you will need to configure OneAgent following the DynaTrace docs;
  - [OpenTelemetry](./opentelemetry.js) will be used for this.
- [Kubernetes deployments](./k8s/) - application, ingress and service;
- [Docker Desktop StorageClass fix](./k8s/docker-desktop/storageclass.yml) for Kubernetes (only when running locally);

## Requirements

- [Node.js](https://nodejs.org/en/) (v18);
- [Docker](https://www.docker.com/products/docker-desktop) (with Docker Compose);
- Kubernetes cluster (if you desire to use it);
- DynaTrace account (if you desire to use it);

## Configs

### Redis

The Redis auth credentials were changed to:

```bash
user default on +@pubsub ~* nopass
user admin on +@all ~* >adminpassword
```

Credentials:

| Username  | Scope    | Password                 |
| --------- | -------- | ------------------------ |
| `default` | `pubsub` | `nopass` (make it empty) |
| `admin`   | `all`    | `adminpassword`          |

> **Note:** you can change the credentials in the [`redis-configmap.yaml`](./k8s/redis/redis-configmap.yaml) file [on these lines](https://github.com/tiagoboeing/nestjs-graphql-schemafirst-docker-k8s/blob/5ad865af51fccf942550d991a662796b34f957ca/k8s/redis/redis-configmap.yaml#L768-L770).

## Workflow

### Local development

You can start the application locally with:

```bash
# with Docker Compose
# -V remove volumes
# --build rebuild the images
docker-compose up --build -V

# You can specify the app port with SERVER_PORT (default will be 3000)
SERVER_PORT=4000 docker-compose up --build -V

# or simply with NodeJS
npm run start:dev
```

#### Configuring environment variables

You can configure the environment variables in the file [`.env.development`](./.env.development).

### Build

> On this repository we are using `integration` as the image name, but you can change it to whatever you want.

You can build the application with:

```bash
# Production build
# using multi-stage build
docker build --target production -t <image-name> .
```

#### Testing production image

```bash
docker run --rm -it -p 3000:3000 <image-name>
```

### Kubernetes cluster

> Firstly you will need to create a Kubernetes cluster. Use any engine, like [K3D](https://k3d.io/), [MiniKube](https://minikube.sigs.k8s.io/docs/start/), [Docker Desktop](https://www.docker.com/products/docker-desktop), etc.

**You can get start (only at the first time) simply running:**

```bash
# This command will create namespaces and apply deployments
sh ./k8s/start-k8s-cluster.sh
```

> **Note:** If you changed the Docker image name to other value (not `integration`), you will need to replace the K8S deployments with the new image.
